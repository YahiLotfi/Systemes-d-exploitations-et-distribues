#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <sys/stat.h>
#include <fcntl.h>
#define SERVER_IP "127.0.0.1"
#define PORT 8080

int main() {
    int server_fd, new_socket, valread;
    struct sockaddr_in address;
    int opt = 1;
    int addrlen = sizeof(address);
    char buffer1[1024] = {0};
    char buffer2[1024] = {0};
   

    // Création du socket
    if ((server_fd = socket(AF_INET, SOCK_STREAM, 0)) == 0) {
        perror("Erreur de création du socket");
        exit(EXIT_FAILURE);
    }

    // Option de socket réutilisable
    if (setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR | SO_REUSEPORT, &opt, sizeof(opt))) {
        perror("Erreur de configuration du socket");
        exit(EXIT_FAILURE);
    }

    // Configuration de l'adresse du socket
    address.sin_family = AF_INET;
    address.sin_addr.s_addr = INADDR_ANY;
    address.sin_port = htons(PORT);

    // Attachement du socket à l'adresse
    if (bind(server_fd, (struct sockaddr *)&address, sizeof(address)) < 0) {
        perror("Erreur de liaison du socket à l'adresse");
        exit(EXIT_FAILURE);
    }

    // Mise en attente de connexions
    if (listen(server_fd, 3) < 0) {
        perror("Erreur lors de la mise en attente des connexions");
        exit(EXIT_FAILURE);
    }

    // Acceptation d'une connexion entrante
    if ((new_socket = accept(server_fd, (struct sockaddr *)&address, (socklen_t*)&addrlen)) < 0) {
        perror("Erreur lors de l'acceptation de la connexion");
        exit(EXIT_FAILURE);
    }
do{
    // Lecture de la chaîne de caractères envoyée par le client
    valread = read(new_socket, buffer1, 1024);

    // Affichage de la chaîne de caractères reçue
    
    printf("Le client a envoyé : %s\n", buffer1);
    //valread = read(new_socket, buffer2, 1024);
    //printf("Le client a envoyé : %s\n", buffer2);
    buffer1[strlen(buffer1)-1]='\0';
    //buffer2[strlen(buffer2)-1]='\0';
   

    // Envoi d'une réponse au client
    //char* response = "d'accord";
   char message[200] ;
    

 
      int fd;
    

    // Création du pipe
    mkfifo("mon_pipe", 0666);

    // Ouverture du pipe en écriture
    fd = open("mon_pipe", O_WRONLY);

    // Écriture des message recu par le clients dans le pipe, exemple Goudale pinte
    write(fd, buffer1, strlen(buffer1)+1);
    
    
    //recevoir la reponse du barman sur la disponibilité
 read(fd, message, 100);
 message[strlen(message)-1]='\0';
 send(new_socket, message, 200, 0);
 
    // Fermeture du pipe
    close(fd);

  }while (1);
    
    
  
    //send(new_socket, message, strlen(message), 0);
    
 //
 //printf("Message reçu : %s\n", message);
 
    // Fermeture du pipe
    //close(fd);

   return 0;
}


  
 

